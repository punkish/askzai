import{$,$$,getInputText,moveCursorToEnd,toggleVisibility,getSpeciesList,cleanUrlParam}from"./utils.js";import{stopWords}from"./stopwords.js";import{Router,reroute}from"./router.js";import{populateExampleDropdown}from"./exampleQueries.js";import SpeciesAutosuggest from"./autosuggest.js";function formatTime(e){const t=36e5,n=864e5;let r=Math.floor(e/n),s=Math.floor((e-r*n)/t),o=Math.round((e-r*n-s*t)/6e4);const a=e=>e<10?"0"+e:e;return 60===o&&(s++,o=0),24===s&&(r++,s=0),`${r} days ${a(s)} hours ${a(o)} mins`}function formatDate(e){const t=e.getFullYear(),n=e.getMonth(),r=e.getDate(),s=e.getHours(),o=e.getMinutes(),a=e.getSeconds();return`${r} ${["January","February","March","April","May","June","July","August","September","October","November","December"][n]}, ${t} ${s}:${o}:${a}`}function literalList(e){function t(e){return`<span class="hl">${e}</span>`}let n=`${e.slice(0,e.length-1||1).map(e=>t(e)).join(", ")}`;return e.length>1&&(n+=` and ${t(e[e.length-1])}`),n}async function toJSON(e){console.log(e);const t=e.getReader(),n=new TextDecoder,r=[];return async function e(){const{done:s,value:o}=await t.read();if(s)return JSON.parse(r.join(""));const a=n.decode(o,{stream:!0});return r.push(a),e()}()}function imageUrl(e){const t={},n=e.split("/")[4];return e.indexOf("zenodo")>-1?e.indexOf(".svg")>-1?(t.src250="/img/kein-preview.png",t.src1200="/img/kein-preview.png"):(t.src250=`${Zai.uris.zenodo}/api/iiif/record:${n}:figure.png/full/250,/0/default.jpg`,t.src1200=`${Zai.uris.zenodo}/api/iiif/record:${n}:figure.png/full/^1200,/0/default.jpg`):t.src250=t.src1200=`${e}/singlefigAOF/`,t}function prepareSearchTerms(e){let t=!1;"?"===e.slice(-1)&&(t=!0,e=e.slice(0,-1));const n=e.split(/\s+/),r=n.filter(e=>e.length>2).filter(e=>!stopWords.includes(e.toLowerCase())).filter(e=>!/^-/.test(e)).filter(e=>/^\+?/.test(e)),s=Array.from(new Set(r)),o=s.map(e=>e.toLowerCase().replace(/^-/,"").replace(/^\+/,"").replace(/(\w+-\w+)/,'"$1"'));let a='data-pop="top" data-pop-no-shadow data-pop-arrow',i=n.map(e=>s.includes(e)?`<span class="hl">${e}</span>`:/^-/.test(e)?`<span aria-label="word removed from search" ${a}>${e}</span>`:/^\+/.test(e)?`<span class="hl" aria-label="stopword included in search" ${a}>${e}</span>`:`<span aria-label="stopword removed from search" ${a}>${e}</span>`).join(" ");return t&&(i+="?"),{searchTerms:o,inputHTML:i}}function stripThink(e){const t="<think>",n="</think>";if(e.indexOf(t)>-1){const r=e.indexOf(t)+7,s=e.indexOf(n),o=e.indexOf(n)+8;return{think:e.substring(r,s),conclusion:e.substring(o)}}return{conclusion:e}}function sourcesHTML(e){const t=e.map((e,t)=>{let n=`<li id="source-${t+1}" class="sources"><a href="${Zai.uris.tb}/${e.treatmentId}" target="_blank">${e.treatmentTitle}</a> from: ${e.articleAuthor} `;return e.publicationDate&&(n+=`(${e.publicationDate}). `),e.articleTitle&&(n+=`${e.articleTitle}. `),e.journalTitle&&(n+=`<i>${e.journalTitle}</i> `,e.journalYear&&(n+=`<i>${e.journalYear}</i>`)),e.articleDOI&&(n+=`, DOI: <a href="https://doi.org/${e.articleDOI}">${e.articleDOI}</a>`),n+="</li>",n}).join("\n");return`Answer generated based on the following ${e.length>1?"treatments":"treatment"}:\n    <ol>${t}</ol>`}function isQueryForSummary(e){const t=e.toLowerCase().trim().split(/\s+/);return t.length>=1&&"describe"===t[0]}function addToHistory(e){const t=`heyzai=${e}`;return history.pushState({},"",`?${t}`),t}const converter=new showdown.Converter;async function go(e,t){hidePlaceholder();const n=$("#go");n.classList.add("button--loading");$$("#responses div").forEach(e=>{e.textContent="",e.innerHTML=""});const{searchTerms:r,inputHTML:s}=prepareSearchTerms(e);$("#q").innerHTML=s;const o=addToHistory(e);let a=`${Zai.uris.zenodeo}/v3/treatments?${o}`;const i=$("#refreshCache");(t||i.checked)&&(a+="&refreshCache=true");const c=await fetch(a),l=e.split(" ");let d;if("describe"===l[0].toLowerCase()&&(d=l.slice(1).join(" ")),c.ok){const{query:e,response:t,stored:n,ttl:r,cacheHit:s}=await c.json();let o,a,i,l=e,u=converter.makeHtml(t.answer);d?(o=t.records,i=t.count):(o=t.topRanked,a=t.searchTerms.split(" "),i=t.ftsCount),$("#response").innerHTML=isQueryForSummary(l)?responseForSummary({count:i,binomen:d,records:o}):responseForLLM({searchTerms:a,count:i,stored:n,ttl:r,cacheHit:s});let p="";o[0].images&&o[0].images.length&&(p=o[0].images.length>1?"Here are a few related images\n\n":"Here is a related image\n\n"),type({container:$("#answer"),text:`${u} ${p}`,cb:()=>drawImage({relatedImages:o[0].images,sourceHTML:sourcesHTML(o)})})}n.classList.remove("button--loading")}function niceNumbers(e){if(e>9)return e;return{1:"one",2:"two",3:"three",4:"four",5:"five",6:"six",7:"seven",8:"eight",9:"nine"}[String(e)]}function responseForLLM({searchTerms:e,count:t,stored:n,ttl:r,cacheHit:s}){let o;const a=niceNumbers(t);if(o=1===t?`A full-text search for "${literalList(e)}" found <a href="#source-0">one</a> paper that provides the context for the answer:`:`A full-text search for "${literalList(e)}" found <span class="res">${a}</span> papers. The <a href="#source-0">three top ranked</a> papers provide the context for the answer:`,s){const e=new Date(n),t=-1===r?"never expires":`expires in ${formatTime(new Date(n+r)-new Date)}`;o+=` ${`<span aria-label="cache hit, stored ${formatDate(e)}, ${t}" data-html="true" data-pop="top" data-pop-no-shadow data-pop-arrow data-pop-multiline>ðŸ’¥</span>`}`}return`<p>${o}</p>`}function responseForSummary({count:e,binomen:t,records:n}){const r=1===e?"treatment":"treatments";let s=`Found <span class="res">${niceNumbers(e)}</span> ${r} of the binomen <span class="res">${t}</span>. `;const o=n.findIndex(e=>"sp. nov."===e.status),a=o>-1?n[o]:n[0];return s+=o>-1?'Here is the summary derived from the full text of the treatment with status "sp. nov."':e>1?"Here is the summary derived from the full text of the first treatment":"Here is the summary derived from the full text of the treatment",a.status&&(s+=` with a status <span class="res">${a.status}</span>`),s+=":",`<p>${s}</p>`}function drawImage({relatedImages:e,sourceHTML:t}){if(e){const t=$("#relatedImages");let n="250",r=255;1===e.length?(t.classList.remove("columns"),t.classList.add("column"),Zai.isWideScreen&&(n="1200",r=928)):(t.classList.remove("column"),t.classList.add("columns")),e.filter(e=>""!=e.httpUri).forEach((e,s)=>{const o=document.createElement("figure");o.classList.add(`treatment-image-${s}`);const a=document.createElement("img"),i=imageUrl(e.httpUri);a.src="img/bug.gif",a.dataset.src=i[`src${n}`],a.width=r,a.alt="Treatment Image",a.classList.add("lazyload"),o.appendChild(a);const c=document.createElement("figcaption");c.textContent=e.captionText,o.appendChild(c),t.appendChild(o)})}$("#source").innerHTML=t}function type2({container:e,text:t,speed:n=5,index:r=0,cb:s}){e.innerHTML+=t.charAt(r),setTimeout(()=>{++r<t.length?type({container:e,text:t,index:r,cb:s}):s&&s()},n)}function type({container:e,text:t,typingSpeed:n=5,index:r=0,cb:s,cbDelay:o=1e3}){const a=setInterval(()=>{if(r<t.length){const n=t.substring(0,r+1);e.innerHTML=n,r++}else clearInterval(a),setTimeout(()=>s(),o)},n)}function hidePlaceholder(){$("#placeholder-overlay").classList.add("hidden")}function showPlaceholder(){const e=$("#q"),t=$("#placeholder-overlay");""===e.textContent.trim()&&t.classList.remove("hidden")}function reset(e){e.preventDefault();const t=$("#q");t.innerHTML="",showPlaceholder(),t.focus()}function onPageLoad(e){e.listen(),$("header img").addEventListener("click",()=>{$("nav").classList.toggle("fade-in-normal"),setTimeout(()=>{$("nav").classList.remove("fade-in-normal")},4e3)}),$("#q").focus(),$("#reset").addEventListener("click",reset)}function tweakUrl(e){window.Zai||(window.Zai={}),Zai.uris={zenodo:"https://zenodo.org",zenodeo:"http://localhost:3010",tb:"https://tb.plazi.org/GgServer/html"},e.indexOf("askzai.net")>-1?Zai.uris.zenodeo="https://test.zenodeo.org":e.indexOf("lucknow.local")>-1&&(Zai.uris.zenodeo="http://lucknow.local:3010"),Zai.bodyWidth=$("body").clientWidth-40,Zai.isWideScreen=Zai.bodyWidth>550}function submitForm(e,t){if(t.length<3)e.dataset.placeholder="C'mon now, say something!",e.classList.add("warning"),setTimeout(()=>{e.dataset.placeholder="Ask me something!",e.classList.remove("warning")},2e3);else{go(addToHistory(t))}}async function getSpecies(e){e||(e=chance.word({length:3}));const t=`${Zai.uris.zenodeo}/v3/binomens?binomen=starts_with(${e})`,n=await fetch(t);if(n.ok){const{query:t,response:r}=await n.json(),{count:s,records:o}=r;if(o){const t=e.toLowerCase(),n=e.length;return o.map(e=>e.binomen).filter(e=>e.substring(0,n).toLowerCase()===t).slice(0,8)}}}function init(){tweakUrl(window.location.href);const e=$(".placeholder-overlay"),t=$("#q"),n=$("#binomen_id");let r;window.focusOnInput=!1,$(".columns").style.setProperty("--container-width",`${Zai.bodyWidth}px`);let s=!1;function o(){r&&(clearInterval(r),r=null),s=!1,t.innerHTML="describe&nbsp;",moveCursorToEnd(t)}function a(e){let n=Math.floor(Math.random()*e.length),o=0,i=e[n];s&&(r=setInterval(()=>{if(o<i.length){const e=i.substring(0,o+1);t.innerHTML=`describe&nbsp;<span class="hl">${e}</span>`,o++}else clearInterval(r),setTimeout(()=>{s&&function(e,n,o,i){if(!s)return;r=setInterval(()=>{if(o>0){o--;const e=i.substring(0,o);t.innerHTML=`describe&nbsp;<span class="hl">${e}</span>`}else clearInterval(r),setTimeout(()=>{if(s){let t;do{t=Math.floor(Math.random()*e.length)}while(t===n&&e.length>1);a(e)}},500)},50)}(e,n,o,i)},2e3)},100))}document.addEventListener("DOMContentLoaded",async()=>{const{count:r,speciesList:i}=await getSpeciesList();Zai.isWideScreen&&(e.innerHTML=`Ask me something, or <span class="placeholder-clickable">I can describe more than ${(r/1e3).toFixed(0)}K species</span>`,$(".placeholder-clickable").addEventListener("click",e=>{e.preventDefault(),hidePlaceholder(),t.focus(),s||(s=!0,t.innerHTML="describe&nbsp;",a(i)),moveCursorToEnd(t)}),t.addEventListener("click",()=>{s&&o()}),t.addEventListener("keydown",()=>{s&&o()})),t.addEventListener("focus",hidePlaceholder),t.addEventListener("blur",showPlaceholder),t.addEventListener("input",()=>{""!==t.textContent.trim()?hidePlaceholder():showPlaceholder()});const c=Array.from($$(".route")).map(e=>({link:e,path:e.getAttribute("href"),component:()=>reroute(e.getAttribute("href").replace("/","").replace(".html",""))}));if(new Router(c).listen(),window.focusOnInput&&t.focus(),$("#reset").addEventListener("click",reset),$("#go").addEventListener("click",e=>{e.preventDefault();const n=getInputText(t);if(n.length<3){const e=$("#placeholder-overlay"),t=e.innerHTML;e.innerHTML="C'mon now, ask something!",e.classList.add("warning"),setTimeout(()=>{e.innerHTML=t,e.classList.remove("warning")},3e3)}else{go(cleanUrlParam(n))}}),await populateExampleDropdown(),$$("#dropdown li").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault(),t.innerText="SPAN"===e.target.tagName?e.target.parentNode.innerText:e.target.innerText,toggleVisibility($("#example-queries"));go(getInputText(t))})}),$(".hint a").addEventListener("click",e=>{e.preventDefault(),toggleVisibility($("#example-queries"))}),$("header img").addEventListener("click",()=>{$("nav").classList.toggle("fade-in-normal"),setTimeout(()=>{$("nav").classList.remove("fade-in-normal")},4e3)}),window.location.search){const e=new URLSearchParams(decodeURIComponent(window.location.search));let t,n=!1;if(e.has("refreshCache")&&(n=!0,e.delete("refreshCache")),e.has("heyzai")){const n=e.get("heyzai").toString();t=cleanUrlParam(n)}go(t,n)}else SpeciesAutosuggest.init({input:t,id:n,suggestionsContainer:$("#suggestions"),form:$("#speciesForm"),getSpecies:getSpecies,doSomethingWithData:go})})}export{init};